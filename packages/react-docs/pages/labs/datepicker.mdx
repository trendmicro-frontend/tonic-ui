# DatePicker

`Datepicker` is used to select a date from a calendar or type in a date value manually. It is composed of `Calendar`, `DateInput`.

## Import

- `DatePicker`: The component that provides the date picker functionality.
- `DatePickerToggle`: The toggle that opens the date picker.
- `DatePickerPopper`: A wrapper that contains the calendar. Must be a direct child of the `DatePicker` component.
- `Calendar`: The calendar component.
- `DateInput`: The input component with `calendar` icon.
- `TimeInput`: The input component with `clock` icon.

```js
import {
  Calendar,
  DateInput,
  DatePicker,
  DatePickerToggle,
  DatePickerPopper,
  TimeInput,
} from '@tonic-ui/react';
```

## Usage

### Calendar

```jsx
<Calendar defaultValue="2022-03-29" onChange={value => console.log(value)} />
```

#### Calendar start day

Use the `calendarStartDay` prop to chage the first day of the calendar week. for example, 0 = Sunday, 1 = Monday.

```jsx
<Stack direction="row" spacing="4x">
  <Stack direction="column" spacing="4x" shouldWrapChildren>
    <Text size="lg">calendarStartDay={0} (default)</Text>
    <Calendar />
  </Stack>
  <Stack direction="column" spacing="4x" shouldWrapChildren>
    <Text size="lg">calendarStartDay={3}</Text>
    <Calendar calendarStartDay={3} />
  </Stack>
</Stack>
```

#### Date format

Use the `dateFormat` prop to change The format of date. Format of the string is based on Unicode Technical Standard #35: https://www.unicode.org/reports/tr35/tr35-dates.html#Date_Field_Symbol_Table.

```jsx
function Example() {
  const [value1, setValue1] = React.useState("2022.03.22");
  const [value2, setValue2] = React.useState("2022.03.22");
  return (
    <Stack direction="row" spacing="4x">
      <Stack direction="column" spacing="4x" shouldWrapChildren>
        <Text size="lg">dateFormat="yyyy-MM-dd" (default)</Text>
        <Calendar
          value={value1}
          onChange={value => setValue1(value)}
        />
        <Box>Date: {value1}</Box>
      </Stack>
      <Stack direction="column" spacing="4x" shouldWrapChildren>
        <Text size="lg">dateFormat="yyyy.MM.dd"</Text>
        <Calendar
          dateFormat="yyyy.MM.dd"
          value= {value2}
          onChange={value => setValue2(value)}
        />
        <Box>Date: {value2} </Box>
      </Stack>
    </Stack>
  );
}
```

### DatePicker

Use the `DatePicker` component to display a calendar and allow the user to select a date.

```jsx
function Example({
  date = '2021-12-15',
  dateFormat = 'yyyy-MM-dd',
  disabled,
}) {
  const [isInvalid, setIsInvalid] = React.useState(false);
  const [isOpenCalendar, setIsOpenCalendar] = React.useState(false);
  const [value, setValue] = React.useState(date);
  const isValidDate = (value) => {
    const pattern = /([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))/;
    return !!String(value).match(pattern);
  };
  const handleDateInputChange = (event) => {
    const value = event.target.value;
    setValue(value);
  };
  const handleCalendarChange = (value) => {
    setValue(value);
    setIsOpenCalendar(false);
  };

  return (
    <DatePicker
      isOpen={isOpenCalendar}
      onOpen={() => setIsOpenCalendar(true)}
      onClose={() => setIsOpenCalendar(false)}
    >
      <DatePickerToggle disabled={disabled}>
        {({ getDatePickerToggleProps, disabled }) => {
          return (
            <DateInput
              dateFormat={dateFormat}
              disabled={disabled}
              isInvalid={!isValidDate(value)}
              value={value}
              onChange={handleDateInputChange}
              width="128px"
              {...getDatePickerToggleProps()}
            />
          );
        }}
      </DatePickerToggle>
      <DatePickerPopper width="max-content">
        <Calendar
          dateFormat={dateFormat}
          value={value}
          onChange={handleCalendarChange}
        />
      </DatePickerPopper>
    </DatePicker>
  );
}
```

#### Date range picker

```jsx noInline
const CustomDateInput = ({
  defaultValue,
  onChange,
  ...rest
}) => {
  const [colorMode] = useColorMode();
  const invalidBorderColor = {
    dark: 'red:50',
    light: 'red:60',
  }[colorMode];
  const [isOpenCalendar, setIsOpenCalendar] = React.useState(false);
  const [value, setValue] = React.useState(defaultValue);
  const handleDateInputChange = (event) => {
    const value = event.target.value;
    setValue(value);
    onChange(value);
  };
  const handleCalendarChange = (value) => {
    onChange(value);
    setValue(value);
    setIsOpenCalendar(false);
  };

  return (
    <DatePicker
      isOpen={isOpenCalendar}
      onOpen={() => setIsOpenCalendar(true)}
      onClose={() => setIsOpenCalendar(false)}
    >
      <DatePickerToggle>
        {({ getDatePickerToggleProps }) => {
          return (
            <DateInput
              value={value}
              onChange={handleDateInputChange}
              width="136px"
              borderTopRightRadius="0"
              borderBottomRightRadius="0"
              _invalid={{
                borderColor: invalidBorderColor,
                zIndex: 1,
              }}
              {...getDatePickerToggleProps()}
              {...rest}
            />
          );
        }}
      </DatePickerToggle>
      <DatePickerPopper width="max-content">
        <Calendar
          value={value}
          onChange={handleCalendarChange}
        />
      </DatePickerPopper>
    </DatePicker>
  );
};

const CustomTimeInput = ({
  onChange,
  ...rest
}) => {
  const handleTimeInputChange = (event) => {
    const value = event.target.value;
    onChange(value);
  };
  return (
    <TimeInput
      onChange={handleTimeInputChange}
      width="128px"
      ml="-1px"
      borderTopLeftRadius="0"
      borderBottomLeftRadius="0"
      {...rest}
    />
  );
};

const DateTimePicker = ({
  startDate: startDateProp,
  startTime: startTimeProp,
  endDate: endDateProp,
  endTime: endTimeProp,
  onApply,
  onClose,
}) => {
  const [colorMode] = useColorMode();
  const [colorStyle] = useColorStyle({ colorMode });
  const [startDate, setStartDate] = React.useState(startDateProp);
  const [startTime, setStartTime] = React.useState(startTimeProp);
  const [endDate, setEndDate] = React.useState(endDateProp);
  const [endTime, setEndTime] = React.useState(endTimeProp);
  const [isInvalid, setIsInvalid] = React.useState(false);
  const isValidDate = (value) => {
    // The date format is "yyyy-MM-dd"
    const pattern = /([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))/;
    return !!String(value).match(pattern);
  };
  const isValidTime = (value) => {
    // The time format is "HH:mm:ss"
    const pattern = /^(?:2[0-3]|[01]?[0-9]):[0-5][0-9]:[0-5][0-9]$/;
    return !!String(value).match(pattern);
  };
  const handleStartDateChange = (value) => {
    setStartDate(value);
  };
  const handleEndDateChange = (value) => {
    setEndDate(value);
  };
  const handleStartTimeChange = (value) => {
    setStartTime(value);
  };
  const handleEndTimeChange = (value) => {
    setEndTime(value);
  };
  const handleApplyClick = () => {
    onApply({
      startDate,
      startTime,
      endDate,
      endTime,
    });
  };

  React.useEffect(() => {
    const isValidStartDate = isValidDate(startDate);
    const isValidStartTime = isValidTime(startTime);
    const isValidEndDate = isValidDate(endDate);
    const isValidEndTime = isValidTime(endTime);
    if (isValidStartDate && isValidEndDate && isValidStartTime && isValidEndTime) {
      // if the end datetime is the earlier than the start datetime, then set the end datetime to the start datetime
      if ((Date.parse(`${endDate} ${endTime}`)).valueOf() < (Date.parse(`${startDate} ${startTime}`)).valueOf()){
        setEndDate(startDate);
        setEndTime('23:59:59');
      } else {
        setIsInvalid(false);
      }
    } else {
      setIsInvalid(true);
    }
  }, [startDate, startTime, endDate, endTime]);

  return (
    <Box
      backgroundColor={colorStyle.background.secondary}
      position="absolute"
      left="100%"
      top={0}
      px="4x"
      py="3x"
      minHeight="100%"
      border={1}
      borderColor={colorStyle.divider}
    >
      <Flex alignItems="center">
        <Text width="64px">From:</Text>
        <CustomDateInput
          isInvalid={!isValidDate(startDate)}
          defaultValue={startDate}
          onChange={handleStartDateChange}
        />
        <CustomTimeInput
          isInvalid={!isValidTime(startTime)}
          defaultValue={startTime}
          onChange={handleStartTimeChange}
        />
      </Flex>
      <Space height="3x" />
      <Flex alignItems="center">
        <Text width="64px">To:</Text>
        <CustomDateInput
          isInvalid={!isValidDate(endDate)}
          value={endDate}
          onChange={handleEndDateChange}
        />
        <CustomTimeInput
          isInvalid={!isValidTime(endTime)}
          value={endTime}
          onChange={handleEndTimeChange}
        />
      </Flex>
      <Space height="3x" />
      <Flex justifyContent="flex-end">
        <Grid templateColumns="1fr 1fr" columnGap="2x">
          <Button
            variant="primary"
            disabled={isInvalid}
            onClick={handleApplyClick}
          >
            Apply
          </Button>
          <Button
            variant="secondary"
            onClick={onClose}
          >
            Cancel
          </Button>
        </Grid>
      </Flex>
    </Box>
  );
};

const stateReducer = (prevState, nextState) => ({
  ...prevState,
  ...(typeof nextState === 'function' ? nextState(prevState) : nextState),
});

const padTo2Digits = (num) => {
  return num.toString().padStart(2, '0');
};

const formatDate = (date) => {
  return (
    [
      date.getFullYear(),
      padTo2Digits(date.getMonth() + 1),
      padTo2Digits(date.getDate()),
    ].join('-')
  );
};

const formatTime = (date) => {
  const hours = date.getHours();
  const minutes = date.getMinutes();
  const seconds = date.getSeconds();
  return (
    [
      padTo2Digits(hours),
      padTo2Digits(minutes),
      padTo2Digits(seconds),
    ].join(':')
  );
};

function Example() {
  const today = new Date();
  const [state, setState] = React.useReducer(stateReducer, {
    value: '1d',
    isDateTimePickerVisible: false,
    startDate: formatDate(today),
    startTime: '00:00:00',
    endDate: formatDate(today),
    endTime: '23:59:59',
  });
  const handleMenuItemClick = (event) => {
    const value = event.currentTarget.getAttribute('value');
    if (value === 'custom') {
      event.preventDefault();
      if (!state.isDateTimePickerVisible) {
        setState({
          isDateTimePickerVisible: true,
        });
      }
      return;
    }

    setState({
      value,
      isDateTimePickerVisible: false,
    });
  };
  const mapValueToLabel = (value) => {
    if (value === 'custom') {
      return 'Custom range';
    }
    return {
      '1d': 'Last 24 hours',
      '7d': 'Last 7 days',
      '14d': 'Last 14 days',
    }[value];
  };
  const dateTimeRange = (() => {
    const value = state.value;
    if (['1d', '7d', '14d', 'custom'].indexOf(value) < 0) {
      return null;
    }

    if (value === 'custom') {
      return `${state.startDate} ${state.startTime} ~ ${state.endDate} ${state.endTime}`;
    }

    const now = new Date();
    let date;
    if (value === '1d') {
      date = new Date(now.setDate(now.getDate() - 1));
    }
    if (value === '7d') {
      date = new Date(now.setDate(now.getDate() - 7));
    }
    if (value === '14d') {
      date = new Date(now.setDate(now.getDate() - 14));
    }

    return `${formatDate(date)} ${formatTime(date)} ~ ${formatDate(new Date())} ${formatTime(new Date())}`;
  })();

  React.useEffect(() => {
    if (state.value === 'custom' && !state.isDateTimePickerVisible) {
      setState({
        isDateTimePickerVisible: true,
      });
    }
  }, [state.value, state.isDateTimePickerVisible]);

  return (
    <>
      <Box mb="3x">The time range: { dateTimeRange }</Box>
      <Menu
        onClose={() => {
          if (state.isDateTimePickerVisible) {
            setState({ isDateTimePickerVisible: false });
          }
        }}
      >
        {({ closeMenu }) => (
          <>
            <MenuButton variant="secondary">
              <Text>{mapValueToLabel(state.value)}</Text>
            </MenuButton>
            <MenuList width="max-content">
              {state.isDateTimePickerVisible && (
                <DateTimePicker
                  dateFormat="yyyy-MM-dd"
                  startDate={state.startDate}
                  startTime={state.startTime}
                  endDate={state.endDate}
                  endTime={state.endTime}
                  onApply={({ startDate, startTime, endDate, endTime }) => {
                    closeMenu();
                    setState({
                      value: 'custom',
                      startDate,
                      startTime,
                      endDate,
                      endTime,
                    });
                  }}
                  onClose={() => {
                    closeMenu();
                  }}
                />
              )}
              {['1d', '7d', '14d'].map(value => (
                <MenuItem
                  key={value}
                  value={value}
                  onClick={handleMenuItemClick}
                >
                  {mapValueToLabel(value)}
                </MenuItem>
              ))}
              <MenuDivider />
              <MenuItem
                value="custom"
                onClick={handleMenuItemClick}
              >
                Custom Period
                <Space width="2x" />
                <Icon icon="angle-right" />
              </MenuItem>
            </MenuList>
          </>
        )}
      </Menu>
    </>
  );
}

render(<Example />);
```

## Accessibility

### Keyboard Interaction

| Key | Action |
| :-- | :----- |
| `ArrowDown` \| `ArrowUp` | When `DatePickerToggle` is focused, opens the date picker. |
| `Escape` | When `DatePickerToggle` is focused, closes the date picker and moves the focus to the toggle. |

## Props

### Calendar

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| calendarStartDay | number | 0 | Set the first day of the calendar week. for example, 0 = Sunday, 1 = Monday. |
| children | ReactNode \| ({ getCalendarProps, ...context }) => ReactNode | | |
| dateFormat | string | 'yyyy-MM-dd' | The format of date. Format of the string is based on Unicode Technical Standard #35: https://www.unicode.org/reports/tr35/tr35-dates.html#Date_Field_Symbol_Table |
| defaultValue | string | | The default value. Use when the component is not controlled. |
| value | string | | The value for calendar. |
| onChange | function | | Callback when the date is clicked. |

### DateInput

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |

### DatePicker

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| children | ReactNode \| (context) => ReactNode | | |
| defaultIsOpen | boolean | `false` | Whether the date picker is open by default. |
| isOpen | boolean | | Whether the date picker is open. |
| onClose | function | | Callback when the date picker is closed. |
| onOpen | function | | Callback when the date picker is opened. |
| placement | string | 'bottom-start' | The placement of the date picker. One of: 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end' |

### DatePickerToggle

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| children | ReactNode \| ({ getDatePickerToggleProps, isOpen, openDatePicker, closeDatePicker }) => ReactNode | | |
| disabled | boolean | | Whether the date picker toggle is disabled. |
| onClick | function | | Callback when the date picker toggle is clicked. |
| onKeyDown | function | | Callback when the user presses a key. |

### DatePickerPopper

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| PopperComponent | ElementType | Popper | The component used for the popover. |
| PopperProps | object | | Props applied to the Popper component. |
| TransitionComponent | ElementType | Collapse | The component used for the transition. |
| TransitionProps | object | | Props applied to the [Transition](http://reactcommunity.org/react-transition-group/transition#Transition-props) element. |
| TransitionProps.appear | boolean | true | |
| children | ReactNode | | |
| offset | [skidding, distance] | [0, 0] | To control the distance and skidding of the calendar. |

### TimeInput

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
