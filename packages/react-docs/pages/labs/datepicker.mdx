# DatePicker

`Datepicker` is used to select a date from a calendar or type in a date value manually. It is composed of `Calendar`, `DateInput`.

## Import

- `DatePicker`: The component that provides the date picker functionality.
- `DatePickerToggle`: The toggle that opens the date picker.
- `DatePickerPopper`: A wrapper that contains the calendar. Must be a direct child of the `DatePicker` component.
- `Calendar`: The calendar component.
- `DateInput`: The input component.

```js
import {
  Calendar,
  DateInput,
  DatePicker,
  DatePickerToggle,
  DatePickerPopper,
} from '@tonic-ui/react';
```

## Usage

### Calendar

```jsx
<Calendar defaultValue="2022-03-29" onChange={value => console.log(value)} />
```

#### Calendar start day

Use the `calendarStartDay` prop to chage the first day of the calendar week. for example, 0 = Sunday, 1 = Monday.

```jsx
<Stack direction="row" spacing="4x">
  <Stack direction="column" spacing="4x" shouldWrapChildren>
    <Text size="lg">calendarStartDay={0} (default)</Text>
    <Calendar />
  </Stack>
  <Stack direction="column" spacing="4x" shouldWrapChildren>
    <Text size="lg">calendarStartDay={3}</Text>
    <Calendar calendarStartDay={3} />
  </Stack>
</Stack>
```

#### Date format

Use the `dateFormat` prop to change The format of date. Format of the string is based on Unicode Technical Standard #35: https://www.unicode.org/reports/tr35/tr35-dates.html#Date_Field_Symbol_Table.

```jsx
function Example() {
  const [value1, setValue1] = React.useState("2022.03.22");
  const [value2, setValue2] = React.useState("2022.03.22");
  return (
    <Stack direction="row" spacing="4x">
      <Stack direction="column" spacing="4x" shouldWrapChildren>
        <Text size="lg">dateFormat="yyyy-MM-dd" (default)</Text>
        <Calendar
          value={value1}
          onChange={value => setValue1(value)}
        />
        <Box>Date: {value1}</Box>
      </Stack>
      <Stack direction="column" spacing="4x" shouldWrapChildren>
        <Text size="lg">dateFormat="yyyy.MM.dd"</Text>
        <Calendar
          dateFormat="yyyy.MM.dd"
          value= {value2}
          onChange={value => setValue2(value)}
        />
        <Box>Date: {value2} </Box>
      </Stack>
    </Stack>
  );
}
```

### DatePicker

Use the `DatePicker` component to display a calendar and allow the user to select a date.

```jsx
function Example({
  date = '2021-12-15',
  dateFormat = 'yyyy-MM-dd',
  disabled,
}) {
  const [isInvalid, setIsInvalid] = React.useState(false);
  const [isOpenCalendar, setIsOpenCalendar] = React.useState(false);
  const [value, setValue] = React.useState(date);
  const isDate = (v) => {
    const d = new Date(v);
    return !Number.isNaN(d.getTime());
  };
  const verifyDate = (value) => {
    if (!value) {
      return;
    }
    setIsInvalid(!isDate(value));
  };
  const handleDateInputChange = (event) => {
    const value = event.target.value;
    setValue(value);
  };
  const handleCalendarChange = (value) => {
    setValue(value);
    setIsOpenCalendar(false);
  };

  React.useEffect(() => {
    verifyDate(value);
  }, [value]);

  return (
    <DatePicker
      isOpen={isOpenCalendar}
      onOpen={() => setIsOpenCalendar(true)}
      onClose={() => setIsOpenCalendar(false)}
    >
      <DatePickerToggle disabled={disabled}>
        {({ getDatePickerToggleProps, disabled }) => {
          return (
            <DateInput
              value={value}
              disabled={disabled}
              isInvalid={isInvalid}
              onChange={handleDateInputChange}
              width="128px"
              {...getDatePickerToggleProps()}
            />
          );
        }}
      </DatePickerToggle>
      <DatePickerPopper width="max-content">
        <Calendar
          value={value}
          onChange={handleCalendarChange}
        />
      </DatePickerPopper>
    </DatePicker>
  );
}
```

#### Date range picker

```jsx noInline
const CustomDatePicker = ({
  value: valueProp,
  dateFormat,
  disabled,
  onChange,
}) => {
  const [isInvalid, setIsInvalid] = React.useState(false);
  const [isOpenCalendar, setIsOpenCalendar] = React.useState(false);
  const [value, setValue] = React.useState(valueProp);
  const isDate = (value) => {
    const d = new Date(value);
    return !Number.isNaN(d.getTime());
  };
  const verifyDate = (value) => {
    if (!value) {
      return;
    }
    setIsInvalid(!isDate(value));
  };
  const handleDateInputChange = (event) => {
    const value = event.target.value;
    onChange(value);
    setValue(value);
  };
  const handleCalendarChange = (value) => {
    onChange(value);
    setValue(value);
    setIsOpenCalendar(false);
  };

  React.useEffect(() => {
    verifyDate(value);
  }, [value]);

  return (
    <DatePicker
      isOpen={isOpenCalendar}
      onOpen={() => setIsOpenCalendar(true)}
      onClose={() => setIsOpenCalendar(false)}
    >
      <DatePickerToggle disabled={disabled}>
        {({ getDatePickerToggleProps, disabled }) => {
          return (
            <DateInput
              value={value}
              disabled={disabled}
              isInvalid={isInvalid}
              onChange={handleDateInputChange}
              width="136px"
              borderTopRightRadius="0"
              borderBottomRightRadius="0"
              {...getDatePickerToggleProps()}
            />
          );
        }}
      </DatePickerToggle>
      <DatePickerPopper width="max-content">
        <Calendar
          value={value}
          onChange={handleCalendarChange}
        />
      </DatePickerPopper>
    </DatePicker>
  );
};

const TimeInput = React.forwardRef((
  props,
  ref
) => {
  const [colorMode] = useColorMode();
  const [colorStyle] = useColorStyle({ colorMode });
  return (
    <Box
      display="inline-flex"
      alignItems="center"
      position="relative"
      width="128px"
    >
      <Box
        display="flex"
        alignItems="center"
        position="absolute"
        left={0}
        px="3x"
        zIndex={3} // The z-index value should be at least 3 for the prepeneded input adornment
      >
        <Icon icon="clock" color={colorStyle.color.secondary} />
      </Box>
      <Input
        ref={ref}
        pl="10x"
        ml="-1px"
        borderTopLeftRadius="0"
        borderBottomLeftRadius="0"
        {...props}
      />
    </Box>
  );
});

const padTo2Digits = (num) => {
  return num.toString().padStart(2, '0');
};

const formatDate = (date) => {
  return (
    [
      date.getFullYear(),
      padTo2Digits(date.getMonth() + 1),
      padTo2Digits(date.getDate()),
    ].join('-')
  );
};

const formatTime = (date) => {
  const hours = date.getHours();
  const minutes = date.getMinutes();
  const seconds = date.getSeconds();
  return (
    [
      padTo2Digits(hours),
      padTo2Digits(minutes),
      padTo2Digits(seconds),
    ].join(':')
  );
};

function Example() {
  const today = new Date();
  const [colorMode] = useColorMode();
  const [colorStyle] = useColorStyle({ colorMode });
  const [value, setValue] = React.useState('1d');
  const [startDate, setStartDate] = React.useState(formatDate(today));
  const [endDate, setEndDate] = React.useState(formatDate(today));
  const [startTime, setStartTime] = React.useState("00:00:00");
  const [endTime, setEndTime] = React.useState("23:59:59");
  const [isCalendarVisible, setIsCalendarVisible] = React.useState(false);

  const handleMenuItemClick = (event) => {
    const value = event.target.getAttribute('value');
    if (value === 'custom') {
      event.preventDefault();
      if (!isCalendarVisible) {
        setIsCalendarVisible(true);
      }
      return;
    }
    setValue(value);
    if (isCalendarVisible) {
      setIsCalendarVisible(false);
    }
  };
  const handleStartDateChange = (value) => {
    setStartDate(value);
  };
  const handleEndDateChange = (value) => {
    setEndDate(value);
  };
  const handleStartTimeChange = (e) => {
    const value = e.target.value;
    setStartTime(value);
  };
  const handleEndTimeChange = (e) => {
    const value = e.target.value;
    setEndTime(value);
  };
  const mapValueToLabel = (value) => {
    if (value === 'custom') {
      return 'Custom range';
    }
    return {
      '1d': 'Last 24 hours',
      '7d': 'Last 7 days',
      '14d': 'Last 14 days',
    }[value];
  };
  const geTimeRange = (value) => {
    if (['1d', '7d', '14d', 'custom'].indexOf(value) < 0) {
      return null;
    }

    if (value === 'custom') {
      return `${startDate} ${startTime} ~ ${endDate} ${endTime}`;
    }

    const now = new Date();
    let date;
    if (value === '1d') {
      date = new Date(now.setDate(now.getDate() - 1));
    }
    if (value === '7d') {
      date = new Date(now.setDate(now.getDate() - 7));
    }
    if (value === '14d') {
      date = new Date(now.setDate(now.getDate() - 14));
    }

    return `${formatDate(date)} ${formatTime(date)} ~ ${formatDate(new Date())} ${formatTime(new Date())}`;
  };

  React.useEffect(() => {
    if (value === 'custom' && !isCalendarVisible) {
      setIsCalendarVisible(true);
    }
  }, [value, isCalendarVisible]);

  return (
    <>
      <Menu
        onClose={() => {
          if (isCalendarVisible) {
            setIsCalendarVisible(false);
          }
        }}
      >
        {({ closeMenu }) => (
          <>
            <MenuButton variant="secondary">
              <Text>{mapValueToLabel(value)}</Text>
            </MenuButton>
            <MenuList width="max-content">
              {isCalendarVisible && (
                <Box
                  backgroundColor={colorStyle.background.secondary}
                  position="absolute"
                  left="100%"
                  top={0}
                  px="4x"
                  py="3x"
                  minHeight="100%"
                  border={1}
                  borderColor={colorStyle.divider}
                >
                  <Flex alignItems="center">
                    <Text width="64px">From:</Text>
                    <CustomDatePicker value={startDate} onChange={handleStartDateChange} />
                    <TimeInput value={startTime} onChange={handleStartTimeChange} />
                  </Flex>
                  <Space height="3x" />
                  <Flex alignItems="center">
                    <Text width="64px">To:</Text>
                    <CustomDatePicker value={endDate} onChange={handleEndDateChange} />
                    <TimeInput value={endTime} onChange={handleEndTimeChange} />
                  </Flex>
                  <Space height="3x" />
                  <Flex justifyContent="flex-end">
                    <Grid
                      templateColumns="1fr 1fr"
                      columnGap="2x"
                    >
                      <Button
                        variant="primary"
                        onClick={() => {
                          closeMenu();
                          if (value !== 'custom') {
                            setValue('custom');
                          }
                        }}
                      >
                        Apply
                      </Button>
                      <Button
                        variant="secondary"
                        onClick={() => {
                          closeMenu();
                        }}
                      >
                        Cancel
                      </Button>
                    </Grid>
                  </Flex>
                </Box>
              )}
              {['1d', '7d', '14d'].map(value => (
                <MenuItem
                  key={value}
                  value={value}
                  onClick={handleMenuItemClick}
                >
                  {mapValueToLabel(value)}
                </MenuItem>
              ))}
              <MenuDivider />
              <MenuItem
                value="custom"
                onClick={handleMenuItemClick}
              >
                Custom Period
                <Space width="2x" />
                <Icon icon="angle-right" />
              </MenuItem>
            </MenuList>
          </>
        )}
      </Menu>
      <Box mt="3x">The time range: { geTimeRange(value) }</Box>
    </>
  );
}

render(<Example />);
```

## Accessibility

### Keyboard Interaction

| Key | Action |
| :-- | :----- |
| `ArrowDown` \| `ArrowUp` | When `DatePickerToggle` is focused, opens the date picker. |
| `Escape` | When `DatePickerToggle` is focused, closes the date picker and moves the focus to the toggle. |

## Props

### Calendar

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| calendarStartDay | number | 0 | Set the first day of the calendar week. for example, 0 = Sunday, 1 = Monday. |
| children | ReactNode \| ({ getCalendarProps, ...context }) => ReactNode | | |
| dateFormat | string | 'yyyy-MM-dd' | The format of date. Format of the string is based on Unicode Technical Standard #35: https://www.unicode.org/reports/tr35/tr35-dates.html#Date_Field_Symbol_Table |
| defaultValue | string | | The default value. Use when the component is not controlled. |
| value | string | | The value for calendar. |
| onChange | function | | Callback when the date is clicked. |

### DateInput

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |

### DatePicker

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| children | ReactNode \| (context) => ReactNode | | |
| defaultIsOpen | boolean | `false` | Whether the date picker is open by default. |
| isOpen | boolean | | Whether the date picker is open. |
| onClose | function | | Callback when the date picker is closed. |
| onOpen | function | | Callback when the date picker is opened. |
| placement | string | 'bottom-start' | The placement of the date picker. One of: 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end' |

### DatePickerToggle

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| children | ReactNode \| ({ getDatePickerToggleProps, isOpen, openDatePicker, closeDatePicker }) => ReactNode | | |
| disabled | boolean | | Whether the date picker toggle is disabled. |
| onClick | function | | Callback when the date picker toggle is clicked. |
| onKeyDown | function | | Callback when the user presses a key. |

### DatePickerPopper

| Name | Type | Default | Description |
| :--- | :--- | :------ | :---------- |
| PopperComponent | ElementType | Popper | The component used for the popover. |
| PopperProps | object | | Props applied to the Popper component. |
| TransitionComponent | ElementType | Collapse | The component used for the transition. |
| TransitionProps | object | | Props applied to the [Transition](http://reactcommunity.org/react-transition-group/transition#Transition-props) element. |
| TransitionProps.appear | boolean | true | |
| children | ReactNode | | |
| offset | [skidding, distance] | [0, 0] | To control the distance and skidding of the calendar. |
